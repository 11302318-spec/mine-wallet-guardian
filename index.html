<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·åŒ…å®ˆé–€å“¡ - æ™ºæ…§ç†è²¡åŠ©æ‰‹</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary: #ffeb3b; --accent: #ff9800; --save: #4CAF50; --danger: #ff5252; --shopping: #9c27b0; }
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: url('https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover; color: #fff; margin: 0;
        }
        .overlay { background-color: rgba(0,0,0,0.5); min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { 
            max-width: 750px; margin: 20px auto; 
            background-color: rgba(255,255,255,0.12); padding: 25px; 
            border-radius: 28px; box-shadow: 0 15px 50px rgba(0,0,0,0.4); 
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }
        .logout-btn { 
            position: absolute; top: 20px; right: 20px; 
            background: rgba(255,255,255,0.1); color: #ccc; 
            font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.3); cursor: pointer;
        }
        h1 { font-size: 2rem; color: var(--primary); text-align: center; margin-bottom: 20px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
        .card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .progress-container { background: #444; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--primary); transition: 0.5s; }
        .save-bar { background: var(--save) !important; }
        
        /* ç¯©é¸å™¨æ¨£å¼ */
        .filter-box { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .filter-box input[type="month"] { width: auto; background: rgba(255,255,255,0.2); color: white; border: 1px solid #777; padding: 5px 10px; margin: 0; }

        .type-toggle { display: flex; margin-bottom: 10px; gap: 5px; }
        .type-btn { flex: 1; padding: 10px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; }
        .type-btn.active-exp { border-color: var(--danger); background: rgba(255,82,82,0.2); }
        .type-btn.active-save { border-color: var(--save); background: rgba(76,175,80,0.2); }
        
        .ai-advisor { background: linear-gradient(135deg, rgba(255,235,59,0.2), rgba(255,152,0,0.2)); border: 2px solid var(--primary); padding: 15px; border-radius: 15px; margin: 20px 0; font-weight: bold; }

        input { width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 12px; border-radius: 10px; border: none; cursor: pointer; transition: 0.2s; font-weight: bold; }
        
        .save-txt { color: var(--save); font-weight: bold; }
        .cate-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: #fff; }
        
        /* æ­·å²ç´€éŒ„è¡¨æ ¼å„ªåŒ– */
        .history-section { max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--primary); border-bottom: 2px solid rgba(255,255,255,0.1); padding: 10px 5px; }
        td { padding: 12px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .app-box { display: none; }
    </style>
</head>
<body>
<div class="overlay">
    <div class="container">
        <h1>ğŸ’° è·åŒ…å®ˆé–€å“¡</h1>
        <div id="authBox">
            <input type="email" id="email" placeholder="ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <button onclick="handleLogin()" style="width: 100%; background: var(--accent); color: #fff;">ç™»å…¥</button>
            <button onclick="handleSignUp()" style="width: 100%; margin-top: 10px; background: var(--save); color: #fff;">è¨»å†Š</button>
        </div>

        <div id="appBox" class="app-box">
            <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
            
            <div class="filter-box">
                <span style="font-size: 0.9rem; color: #ddd;">ğŸ“… æª¢è¦–æœˆä»½ï¼š</span>
                <input type="month" id="monthFilter" onchange="loadData()">
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between;">
                    <span><span id="displayMonth">æœ¬</span>æœˆæ”¯å‡º ($<span id="monthSpend">0</span> / $<span id="budgetVal">10000</span>)</span>
                    <a href="javascript:setBudget()" style="color: var(--primary); font-size: 0.8rem;">[è¨­å®šé ç®—]</a>
                </div>
                <div class="progress-container"><div id="budgetBar" class="progress-bar"></div></div>
            </div>

            <div class="ai-advisor">ğŸ¤– è»å¸«ï¼š<span id="aiText">æ­£åœ¨è®€å–æ­·å²å·è»¸...</span></div>

            <div class="type-toggle">
                <button id="modeExp" class="type-btn active-exp" onclick="setMode('expense')">ğŸ’¸ è¨˜æ”¯å‡º</button>
                <button id="modeSave" class="type-btn" onclick="setMode('saving')">ğŸ’° è¨˜å­˜éŒ¢</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="recordInput" placeholder="å¦‚: æ™šé¤ 120">
                <button id="mainBtn" onclick="addRecord()" style="flex: 1; background: var(--accent); color: white;">ç¢ºèª</button>
            </div>
            
            <canvas id="myChart" style="max-height: 180px; margin: 20px 0;"></canvas>

            <h3 style="color: var(--primary); margin-bottom: 10px;">ğŸ•’ æ­·å²ç´€éŒ„</h3>
            <div class="history-section">
                <table>
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>åˆ†é¡/é …ç›®</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody id="recordTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const sounds = {
        success: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
        delete: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
        login: new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3')
    };
    function playSfx(type) { sounds[type].currentTime = 0; sounds[type].play().catch(() => {}); }

    const firebaseConfig = {
      apiKey: "AIzaSyBuk3dItipnTiXU8SP46yv6yTW1aIjCGuU",
      authDomain: "ai-expense-20060213.firebaseapp.com",
      projectId: "ai-expense-20060213",
      storageBucket: "ai-expense-20060213.firebasestorage.app",
      messagingSenderId: "14396823732",
      appId: "1:14396823732:web:f609d9867139091e9d5fe1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    let currentUser = null, myChart = null, currentMode = 'expense';
    let monthlyBudget = 10000;

    // åˆå§‹åŒ–æœˆä»½ç¯©é¸å™¨ç‚ºç•¶æœˆ
    const now = new Date();
    document.getElementById('monthFilter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('appBox').style.display = 'block';
            playSfx('login'); loadSettings(); initChart(); loadData();
        } else {
            document.getElementById('authBox').style.display = 'block';
            document.getElementById('appBox').style.display = 'none';
        }
    });

    function getCategory(item) {
        if (currentMode === 'saving') return "å­˜æ¬¾";
        const rules = [
            { cat: "é£²æ–™", regex: /é£²|æ°´|å¥¶|èŒ¶|å•¡|æ±|å¯æ¨‚|é›ªç¢§|èŠ¬é”|æ±½æ°´|ç´…ç‰›|æ€ªç¸|é…’|æ¼¿|å¯å¯|å·§å…‹åŠ›|æŠ¹èŒ¶|æ˜”|é†‹|éœ²|å¤š|æ‹¿éµ|æ‘©å¡|ç‘ªå¥‡æœµ/ },
            { cat: "äº¤é€š", regex: /è»Š|æ©Ÿ|èˆ¹|è‰‡|è»Œ|åˆ—è»Š|éµ|é«˜éµ|æ·é‹|åœ°éµ|å·´å£«|æ‚ éŠ|Uber|æ»‘æ¿|ç´¢|é›»æ¢¯|æ¢¯|èˆª|é£›|ç©º|ç«ç®­|ç‰©æµ|é…é€|å–è²¨/ },
            { cat: "é¤é£²", regex: /é£¯|éºµ|é¥…|åŒ…|é¤ƒ|ç‡’|é¤…|æ²¹æ¢|å£½å¸|åˆºèº«|å¤©å©¦ç¾…|å’–å“©|ç³°|ä¾¿ç•¶|ç‚’|ç‡´|ç²¥|é‹|çˆ|æ¹¯|çƒ¤|æ’|é›|é´¨|éµ|è‚‰|è±†è…|èŒ„|è¦|é­š|è–¯|æ¼¢å ¡|ç‹—|æ˜æ²»|è²æœ|æŠ«è–©|ç¾©å¤§|ç„—|è›‹|å¡”|é¤…|ç³–|å·§å…‹åŠ›|å†°|æœå‡|è›‹ç³•|æ³¡èŠ™/ },
            { cat: "è³¼ç‰©", regex: /è¡£|è¤²|é‹|åŒ…|å¸½|è¥ª|é£¾|é …éŠ|æˆ’|è€³|é«®|å¦|ä¹³|æ¶²|ç²¾è¯|çš‚|æ´—|ç´™|å·¾|æ£‰|å°¿å¸ƒ|æ½”|å…·|å®¶å…·|æ¡Œ|æ¤…|åºŠ|ç‡ˆ|æ©Ÿ|è…¦|ç­†|æ›¸|æ–‡å…·|å¯µç‰©|è²“|ç‹—|å¬°|æŠ˜|è³¼|åº—|ç¶²|åˆ·|æ¬¾|ç®±|å¢Š|é¡|éŒ¶|åˆ€|å‰ª|å‚˜|å·¥å…·|ç©å…·/ }
        ];
        for (let rule of rules) if (rule.regex.test(item)) return rule.cat;
        return "å…¶ä»–";
    }

    function addRecord() {
        const input = document.getElementById("recordInput").value.trim();
        const parts = input.split(" ");
        if(parts.length < 2) return Swal.fire('æç¤º', 'è«‹è¼¸å…¥ã€Œé …ç›® é‡‘é¡ã€', 'info');
        const item = parts[0], amount = parseFloat(parts[1]);
        const category = getCategory(item);
        db.collection("users").doc(currentUser.uid).collection("records").add({
            item, amount, category, type: currentMode,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { 
            playSfx('success');
            document.getElementById("recordInput").value = ""; 
            loadData(); 
        });
    }

    function loadData() {
        const filterVal = document.getElementById('monthFilter').value; // æ ¼å¼: "2023-10"
        const [fYear, fMonth] = filterVal.split('-').map(Number);
        document.getElementById('displayMonth').innerText = fMonth;

        db.collection("users").doc(currentUser.uid).collection("records").orderBy("timestamp", "desc").get().then(snapshot => {
            const tbody = document.getElementById("recordTable");
            tbody.innerHTML = "";
            let totals = { é£²æ–™:0, é¤é£²:0, äº¤é€š:0, è³¼ç‰©:0, å…¶ä»–:0 };
            let filteredSpend = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                const date = d.timestamp ? d.timestamp.toDate() : new Date();
                
                // ç¯©é¸æœˆä»½é‚è¼¯
                if (date.getFullYear() === fYear && (date.getMonth() + 1) === fMonth) {
                    const tr = document.createElement("tr");
                    const isSaving = d.type === 'saving';
                    const colorClass = isSaving ? 'save-txt' : '';
                    
                    tr.innerHTML = `
                        <td>${date.getMonth()+1}/${date.getDate()}</td>
                        <td class="${colorClass}"><span class="cate-badge" style="background:${getCatColor(d.category, d.type)}">${isSaving?'å­˜æ¬¾':(d.category||"å…¶ä»–")}</span>${d.item}</td>
                        <td class="${colorClass}">$${d.amount}</td>
                        <td><button onclick="delRec('${doc.id}')" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:3px 8px; cursor:pointer;">åˆªé™¤</button></td>
                    `;
                    tbody.appendChild(tr);

                    if (!isSaving) {
                        filteredSpend += d.amount;
                        if(totals[d.category] !== undefined) totals[d.category] += d.amount;
                        else totals['å…¶ä»–'] += d.amount;
                    }
                }
            });
            updateUI(filteredSpend, totals);
        });
    }

    function updateUI(spend, totals) {
        let spendPercent = (spend / monthlyBudget) * 100;
        document.getElementById('budgetBar').style.width = Math.min(spendPercent, 100) + '%';
        document.getElementById('budgetBar').style.background = spendPercent > 85 ? 'var(--danger)' : 'var(--primary)';
        document.getElementById('monthSpend').innerText = spend;

        let maxCat = Object.keys(totals).reduce((a, b) => totals[a] > totals[b] ? a : b);
        let aiMsg = spend === 0 ? "è©²æœˆå°šç„¡æ•¸æ“šï¼Œå¿«é–‹å§‹è¨˜å¸³å§ï¼" : (spendPercent > 100 ? "è­¦å ±ï¼è©²æœˆå·²è¶…æ”¯ï¼" : `ç›®å‰ã€Œ${maxCat}ã€æ˜¯ä¸»è¦èŠ±è²»ï¼Œè«‹å¤šç•™æ„ã€‚`);
        document.getElementById('aiText').innerText = aiMsg;

        myChart.data.datasets[0].data = [totals.é£²æ–™, totals.é¤é£², totals.äº¤é€š, totals.è³¼ç‰©, totals.å…¶ä»–];
        myChart.update();
    }

    function getCatColor(cat, type) {
        if(type === 'saving') return 'var(--save)';
        const colors = { 'é£²æ–™': '#ff5252', 'é¤é£²': '#42a5f5', 'äº¤é€š': '#ffca28', 'è³¼ç‰©': '#9c27b0', 'å…¶ä»–': '#4db6ac' };
        return colors[cat] || '#4db6ac';
    }

    function initChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, { 
            type: 'doughnut', 
            data: { labels: ['é£²æ–™', 'é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å…¶ä»–'], datasets: [{ data: [0,0,0,0,0], backgroundColor: ['#ff5252', '#42a5f5', '#ffca28', '#9c27b0', '#4db6ac'] }] }, 
            options: { plugins: { legend: { position: 'right', labels: { color: '#fff', boxWidth: 10, font: {size: 10} } } } } 
        });
    }

    function delRec(id) {
        Swal.fire({title: 'ç¢ºå®šåˆªé™¤?', icon:'warning', showCancelButton:true, confirmButtonColor: '#ff5252'}).then(res => {
            if(res.isConfirmed) {
                db.collection("users").doc(currentUser.uid).collection("records").doc(id).delete().then(() => {
                    playSfx('delete'); loadData();
                });
            }
        });
    }

    function setMode(mode) { currentMode = mode; document.getElementById('modeExp').className = mode === 'expense' ? 'type-btn active-exp' : 'type-btn'; document.getElementById('modeSave').className = mode === 'saving' ? 'type-btn active-save' : 'type-btn'; }
    function loadSettings() { db.collection("users").doc(currentUser.uid).get().then(doc => { if(doc.exists) { monthlyBudget = doc.data().budget || 10000; document.getElementById('budgetVal').innerText = monthlyBudget; } }); }
    function setBudget() { Swal.fire({ title: 'è¨­å®šæœˆé ç®—', input: 'number', inputValue: monthlyBudget }).then(res => { if(res.value) { monthlyBudget = parseInt(res.value); db.collection("users").doc(currentUser.uid).set({ budget: monthlyBudget }, {merge:true}).then(loadData); } }); }
    function handleLogout() { auth.signOut().then(() => { playSfx('login'); Swal.fire('å·²ç™»å‡º', 'ä¸‹æ¬¡è¦‹ï¼', 'success'); }); }
    function handleLogin() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => Swal.fire('éŒ¯èª¤', e.message, 'error')); }
    function handleSignUp() { auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).then(() => Swal.fire('æ­¡è¿', 'å¸³è™Ÿå·²å»ºç«‹', 'success')); }
</script>
</body>
</html>
